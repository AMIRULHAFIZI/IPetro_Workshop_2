{% if current_user.role.role_name == 'Admin' %}
    {% extends 'base_admin.html' %}
{% elif current_user.role.role_name == 'Manager' %}
    {% extends 'base_manager.html' %}
{% else %}
    {% extends 'base.html' %} 
{% endif %}

{% block title %}Manual Data Input - {{ super() }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    
    <!-- Flash Message Display -->
    <div class="mb-6">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% set category_class = 'bg-blue-100 border-blue-400 text-blue-700' %}
                    {% if category == 'success' %}
                        {% set category_class = 'bg-green-100 border-green-400 text-green-700' %}
                    {% elif category == 'error' %}
                        {% set category_class = 'bg-red-100 border-red-400 text-red-700' %}
                    {% endif %}
                    <div class="{{ category_class }} border px-4 py-3 rounded-lg relative mb-3" role="alert">
                        <span class="block sm:inline">{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <h1 class="text-3xl font-bold text-gray-800 mb-6">Manual Data Input</h1>
    
    <form action="{{ url_for('save_data') }}" method="POST">
        <!-- This form posts to the same 'save_data' route -->
        <!-- We do NOT include a 'temp_file' input -->

        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <!-- Header with controls -->
            <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-700">Equipment Data</h2>
                <div class="flex space-x-2">
                    <button type="button" id="add-row-btn" 
                            class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i data-lucide="plus" class="w-4 h-4 inline-block -mt-1"></i> Add Row
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                        <i data-lucide="save" class="w-4 h-4 inline-block -mt-1"></i> Save Data
                    </button>
                </div>
            </div>

            <!-- Table container for horizontal scrolling -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">NO.</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">EQUIPMENT NO.</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">PMT NO.</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">EQUIPMENT DESCRIPTION</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">PARTS</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">PHASE</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">FLUID</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">TYPE</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">SPEC.</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">GRADE</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">INSULATION</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">DESIGN TEMP.</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">DESIGN PRESSURE</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">OPERATING TEMP.</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">OPERATING PRESSURE</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">SOURCE DRAWING</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="empty-message" class="text-center p-8 text-gray-500">
                <i data-lucide="list-x" class="w-12 h-12 mx-auto mb-2"></i>
                <p>No data added yet. Click "Add Row" to begin.</p>
            </div>
        </div>
    </form>
</div>

<!-- Template for a new row (for JavaScript) -->
<template id="row-template">
    <tr class="data-row">
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="NO." class="form-input" size="3"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="EQUIPMENT NO. " class="form-input" value="V-001" size="8"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="PMT NO." class="form-input" size="10"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="EQUIPMENT DESCRIPTION" class="form-input" size="15"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="PARTS" class="form-input" size="10"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="PHASE" class="form-input" size="5"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="FLUID" class="form-input" size="8"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="TYPE" class="form-input" size="5"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="SPEC." class="form-input" size="8"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="GRADE" class="form-input" size="5"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="INSULATION" class="form-input" size="5"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="TEMP. (°C) " class="form-input" size="8"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="PRESSURE (Mpa) " class="form-input" size="8"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="TEMP. (°C)" class="form-input" size="8"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="PRESSURE (Mpa)" class="form-input" size="8"></td>
        <td class="px-2 py-1 whitespace-nowrap"><input type="text" name="source_drawing" class="form-input" value="Manual Input" size="10"></td>
        <td class="px-2 py-1 whitespace-nowrap">
            <button type="button" class="text-red-600 hover:text-red-800" onclick="deleteRow(this)">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
        </td>
    </tr>
</template>

<style>
    .form-input {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
    }
    .form-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px #bfdbfe;
        outline: none;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const addRowBtn = document.getElementById('add-row-btn');
    const tableBody = document.getElementById('data-table-body');
    const template = document.getElementById('row-template');
    const emptyMessage = document.getElementById('empty-message');
    let rowCount = 0;

    function checkEmpty() {
        if (rowCount > 0) {
            emptyMessage.style.display = 'none';
        } else {
            emptyMessage.style.display = 'block';
        }
    }

    function addRow() {
        rowCount++;
        const newRow = template.content.cloneNode(true);
        // Set the 'NO.' field
        newRow.querySelector('input[name="NO."]').value = rowCount;
        tableBody.appendChild(newRow);
        
        // Re-activate icons in the new row
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        checkEmpty();
    }

    // Add one row to start with
    addRow();

    addRowBtn.addEventListener('click', addRow);

    // Make deleteRow function global
    window.deleteRow = function(button) {
        button.closest('tr').remove();
        rowCount--;
        // Re-number all 'NO.' fields
        const allRows = tableBody.querySelectorAll('.data-row');
        allRows.forEach((row, index) => {
            row.querySelector('input[name="NO."]').value = index + 1;
        });
        rowCount = allRows.length; // Recalculate count
        checkEmpty();
    }

    // Activate icons on initial load
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}