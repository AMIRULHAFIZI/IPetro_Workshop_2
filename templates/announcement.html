{% extends 'base_admin.html' %}

{% block title %}Manage Announcements - {{ super() }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">

    <!-- 1. Flash Message Display -->
     <!-- 1testy -->
    <div class="mb-6">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% set category_class = 'bg-blue-100 border-blue-400 text-blue-700' %}
                    {% if category == 'success' %}
                        {% set category_class = 'bg-green-100 border-green-400 text-green-700' %}
                    {% elif category == 'error' %}
                        {% set category_class = 'bg-red-100 border-red-400 text-red-700' %}
                    {% endif %}
                    <div class="{{ category_class }} border px-4 py-3 rounded-lg relative mb-3" role="alert">
                        <span class="block sm:inline">{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- 2. Create New Announcement Card -->
    <div class="bg-white p-8 rounded-lg shadow-md mb-8">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">
            Create New Announcement
        </h1>
        
        <form action="{{ url_for('admin_announcement') }}" method="POST" enctype="multipart/form-data" class="space-y-6">
            {{ form.hidden_tag() }}
            
            <!-- Message (Text Area) -->
            <div>
                <label for="message" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.message.label }}
                </label>
                {{ form.message(
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm
                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                    rows=5,
                    placeholder="Type your message here..."
                )}}
            </div>
            
            <!-- File Upload -->
            <div>
                <label for="attachment" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.attachment.label }}
                </label>
                {{ form.attachment(
                    class="w-full text-sm text-gray-500 border border-gray-300 rounded-lg cursor-pointer
                           file:cursor-pointer file:bg-gray-100 file:border-0 file:px-4 file:py-2
                           file:mr-4 file:text-gray-700 file:font-medium hover:file:bg-gray-200"
                )}}
                <p class="text-xs text-gray-500 mt-1">Allowed types: pdf, png, jpg, xlsx.</p>
            </div>

            <!-- NEW: Role Visibility Checkboxes -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Visible To
                </label>
                <div class="flex items-center space-x-6">
                    <div class="flex items-center">
                        {{ form.visible_to_manager(
                            class="h-4 w-4 text-blue-600 border-gray-300 rounded
                                   focus:ring-blue-500 cursor-pointer"
                        )}}
                        <label for="visible_to_manager" class="ml-2 block text-sm text-gray-900 cursor-pointer">
                            {{ form.visible_to_manager.label }}
                        </label>
                    </div>
                    <div class="flex items-center">
                        {{ form.visible_to_engineer(
                            class="h-4 w-4 text-blue-600 border-gray-300 rounded
                                   focus:ring-blue-500 cursor-pointer"
                        )}}
                        <label for="visible_to_engineer" class="ml-2 block text-sm text-gray-900 cursor-pointer">
                            {{ form.visible_to_engineer.label }}
                        </label>
                    </div>
                </div>
            </div>
            <!-- END NEW -->
            
            <!-- Submit Button -->
            <div>
                {{ form.submit(
                    class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md
                           hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
                           transition duration-150 ease-in-out cursor-pointer"
                )}}
            </div>
        </form>
    </div>
    
    <!-- 3. Existing Announcements List -->
    <div class="bg-white p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">
            Announcement History
        </h2>
        <div class="space-y-6">
            {% if announcements %}
                {% for announcement in announcements %}
                <div class="border-b border-gray-200 pb-6">
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="h-10 w-10 bg-gray-300 rounded-full flex items-center justify-center">
                                <i data-lucide="user-shield" class="w-5 h-5 text-gray-600"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">{{ announcement.user.name or announcement.user.username }}</p>
                                <p class="text-xs text-gray-500">
                                    {{ announcement.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                </p>
                            </div>
                        </div>
                        
                        <!-- NEW: Visibility Tags -->
                        <div class="flex items-center space-x-2">
                            {% if announcement.visible_to_manager %}
                                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                    Managers
                                </span>
                            {% endif %}
                            {% if announcement.visible_to_engineer %}
                                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                    Engineers
                                </span>
                            {% endif %}
                        </div>
                        <!-- END NEW -->
                    </div>
                    
                    <!-- Body -->
                    <div class="prose prose-sm max-w-none text-gray-700 mb-4">
                        <p>{{ announcement.message | safe }}</p>
                    </div>

                    <!-- Attachment -->
                    {% if announcement.attachment_filename %}
                    <div class="mt-4">
                        <a href="{{ url_for('download_announcement', filename=announcement.attachment_filename) }}"
                           class="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-800
                                  py-2 px-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                            <i data-lucide="paperclip" class="w-4 h-4 mr-2"></i>
                            Download: {{ announcement.attachment_filename }}
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center text-gray-500 py-8">
                    <i data-lucide="bell-off" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                    <p>No announcements have been posted yet.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
<script>
    // Make sure lucide icons are created on this page
    document.addEventListener('DOMContentLoaded', (event) => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    });
</script>
{% endblock %}