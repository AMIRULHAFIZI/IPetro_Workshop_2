{% extends "base_manager.html" %}

{% block title %}Inspection Readiness Report{% endblock %}

{% block head %}
<!-- Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    @media print {
        body * {
            visibility: hidden;
        }
        #report-content, #report-content * {
            visibility: visible;
        }
        #report-content {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
        .no-print {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    
    <!-- Header with Actions -->
    <div class="flex justify-between items-center mb-8 no-print">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Equipment Integrity Report</h1>
            <p class="text-gray-500 mt-1">Generated on {{ current_date }}</p>
        </div>
        <button onclick="window.print()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors shadow-sm">
            <i data-lucide="printer" class="w-5 h-5"></i>
            Print Report
        </button>
    </div>

    <!-- Printable Content Area -->
    <div id="report-content" class="space-y-8">
        
        <!-- Section 1: Executive Summary -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">1. Executive Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Total Files Uploaded -->
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-blue-100 text-blue-600 rounded-full">
                            <i data-lucide="file-text" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-blue-600 uppercase tracking-wide">Total Files Uploaded</p>
                            <p class="text-3xl font-bold text-gray-900">{{ total_files }}</p>
                        </div>
                    </div>
                </div>

                <!-- Total Components -->
                <div class="p-4 bg-purple-50 rounded-lg border border-purple-100">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-purple-100 text-purple-600 rounded-full">
                            <i data-lucide="layers" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-purple-600 uppercase tracking-wide">Extracted Components</p>
                            <p class="text-3xl font-bold text-gray-900">{{ total_components }}</p>
                        </div>
                    </div>
                </div>

                <!-- AI Success Rate -->
                <div class="p-4 {% if success_rate > 80 %}bg-green-50 border-green-100{% else %}bg-orange-50 border-orange-100{% endif %} rounded-lg border">
                    <div class="flex items-center gap-4">
                        <div class="p-3 {% if success_rate > 80 %}bg-green-100 text-green-600{% else %}bg-orange-100 text-orange-600{% endif %} rounded-full">
                            <i data-lucide="activity" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium {% if success_rate > 80 %}text-green-600{% else %}text-orange-600{% endif %} uppercase tracking-wide">Extraction Confidence</p>
                            <p class="text-3xl font-bold text-gray-900">{{ success_rate }}%</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Old Section 2 Removed -->

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Section 2: Material Summary (Chart) - Renumbered from 3 -->
            <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">2. Material Summary (Bill of Materials)</h2>
                <div class="relative h-64 w-full flex items-center justify-center">
                    <canvas id="materialChart"></canvas>
                </div>
                <div class="mt-4 text-sm text-gray-500 text-center">
                    Distribution of extracted material types across all equipment.
                </div>
            </section>

            <!-- Section 3: Operating Envelope & Risk - Renumbered from 4 -->
            <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">3. Operating Envelope</h2>
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-2">Identified Fluids</h3>
                        <div class="flex flex-wrap gap-2">
                            {% for fluid in fluids %}
                                <span class="px-3 py-1 bg-blue-100 text-blue-700 text-sm font-medium rounded-full">{{ fluid }}</span>
                            {% else %}
                                <span class="text-gray-500 italic">No fluids extracted.</span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-2">Risk Rating Overview</h3>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="text-gray-700">Majority detected as <span class="font-bold">LOW</span> Risk based on process conditions (< 120°C).</span>
                        </div>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="font-semibold text-yellow-800 mb-1 flex items-center gap-2">
                            <i data-lucide="alert-circle" class="w-4 h-4"></i>
                            Insulation Check
                        </h3>
                        <p class="text-sm text-yellow-700">Ensure all items marked with 'Hot Water' (>60°C) are verified for insulation to prevent CUI (Corrosion Under Insulation).</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Old Section 5 Removed -->

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prepare Chart Data from Flask
        const labels = JSON.parse('{{ mat_labels | safe }}');
        const counts = JSON.parse('{{ mat_counts | safe }}');

        const ctx = document.getElementById('materialChart').getContext('2d');
        const materialChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Count',
                    data: counts,
                    backgroundColor: [
                        '#3b82f6', // blue-500
                        '#10b981', // green-500
                        '#f59e0b', // amber-500
                        '#ef4444', // red-500
                        '#8b5cf6', // violet-500
                        '#6366f1', // indigo-500
                        '#ec4899', // pink-500
                        '#64748b'  // slate-500
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: {
                                family: "'Inter', sans-serif",
                                size: 12
                            },
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}